version: '2.1'

services:
  # -------------------------------------------------------------------------
  # NGINX (Traefik Interface)
  # -------------------------------------------------------------------------
  nginx-mailcow:
    image: ghcr.io/mailcow/nginx:1.05
    depends_on:
      - sogo-mailcow
      - php-fpm-mailcow
      - redis-mailcow
    command: /bin/bash -c "envsubst < /etc/nginx/conf.d/templates/listen_plain.template > /etc/nginx/conf.d/listen_plain.conf && envsubst < /etc/nginx/conf.d/templates/listen_ssl.template > /etc/nginx/conf.d/listen_ssl.conf && envsubst < /etc/nginx/conf.d/templates/server_name.template > /etc/nginx/conf.d/server_name.conf && nginx -g 'daemon off;'"
    environment:
      # Ensure IPV4_NETWORK is passed so Nginx can ping containers
      - IPV4_NETWORK=${IPV4_NETWORK:-172.22.1}
      - HTTPS_PORT=${HTTPS_PORT:-8443}
      - HTTP_PORT=${HTTP_PORT:-8080}
      - MAILCOW_HOSTNAME=${MAILCOW_HOSTNAME}
      - TZ=${TZ}
    volumes:
      - /opt/mailcow-data/web:/web:rw
      - /opt/mailcow-data/conf/nginx:/etc/nginx/conf.d:rw
      - /opt/mailcow-data/assets/ssl:/etc/ssl/mail/nginx:ro
    ports:
      - "${HTTP_BIND:-0.0.0.0}:${HTTP_PORT:-8080}:80"
      - "${HTTPS_BIND:-0.0.0.0}:${HTTPS_PORT:-8443}:443"
    networks:
      mailcow-network:
        aliases:
          - nginx
      dokploy-network:
    
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.mailcow-http.rule=Host(`${MAILCOW_HOSTNAME}`)"
      - "traefik.http.routers.mailcow-http.entrypoints=web"
      - "traefik.http.routers.mailcow-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.routers.mailcow-https.rule=Host(`${MAILCOW_HOSTNAME}`)"
      - "traefik.http.routers.mailcow-https.entrypoints=websecure"
      - "traefik.http.routers.mailcow-https.tls=true"
      - "traefik.http.routers.mailcow-https.tls.certresolver=letsencrypt"
      - "traefik.http.services.mailcow-svc.loadbalancer.server.port=80"
      - "traefik.http.routers.mailcow-autoconfig.rule=Host(`autoconfig.ztechai.us`) || Host(`autodiscover.ztechai.us`)"
      - "traefik.http.routers.mailcow-autoconfig.entrypoints=websecure"
      - "traefik.http.routers.mailcow-autoconfig.tls=true"
      - "traefik.http.routers.mailcow-autoconfig.tls.certresolver=letsencrypt"

  # -------------------------------------------------------------------------
  # CORE SERVICES
  # -------------------------------------------------------------------------
  
  dockerapi-mailcow:
    image: ghcr.io/mailcow/dockerapi:2.11
    restart: always
    environment:
      # ADDED DBHOST
      - DBHOST=mysql
      - DBUSER=${DBUSER}
      - DBNAME=${DBNAME}
      - DBPASS=${DBPASS}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      mailcow-network:
        aliases:
          - dockerapi

  mysql-mailcow:
    image: mariadb:10.11
    command: --default-authentication-plugin=mysql_native_password --innodb-buffer-pool-size=64M
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${DBROOT}
      - MYSQL_DATABASE=${DBNAME}
      - MYSQL_USER=${DBUSER}
      - MYSQL_PASSWORD=${DBPASS}
      - MYSQL_INITDB_SKIP_TZINFO=1
    volumes:
      - /opt/mailcow-data/mysql:/var/lib/mysql:rw
    networks:
      mailcow-network:
        aliases:
          - mysql

  redis-mailcow:
    image: redis:7.4.6-alpine
    # Hardcoded password to ensure stability
    command: ["redis-server", "--requirepass", "SecureRedisPass2025"]
    restart: always
    volumes:
      - /opt/mailcow-data/redis:/data:rw
    networks:
      mailcow-network:
        aliases:
          - redis
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "SecureRedisPass2025", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  clamd-mailcow:
    image: ghcr.io/mailcow/clamd:1.71
    restart: always
    volumes:
      - /opt/mailcow-data/clamd:/var/lib/clamav:rw
    networks:
      mailcow-network:
        aliases:
          - clamd

  postfix-mailcow:
    image: ghcr.io/mailcow/postfix:1.81
    restart: always
    environment:
      - TZ=${TZ}
      - DBHOST=mysql
    volumes:
      - /opt/mailcow-data/postfix:/opt/postfix/conf:rw
      - /opt/mailcow-data/postfix/postfix-vol-1:/var/spool/postfix:rw
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
    networks:
      mailcow-network:
        aliases:
          - postfix

  dovecot-mailcow:
    image: ghcr.io/mailcow/dovecot:2.35
    restart: always
    environment:
      - DOVECOT_MASTER_USER=${DOVECOT_MASTER_USER:-}
      - DOVECOT_MASTER_PASS=${DOVECOT_MASTER_PASS:-}
      - DBHOST=mysql
      - TZ=${TZ}
    volumes:
      - /opt/mailcow-data/dovecot:/etc/dovecot/sql:rw
      - /opt/mailcow-data/conf/dovecot:/etc/dovecot/conf.d:rw
      - /opt/mailcow-data/assets/ssl:/etc/ssl/mail/dovecot:ro
      - /opt/mailcow-data/vmail:/var/vmail:rw
      - /opt/mailcow-data/crypt:/var/lib/zeyple:rw
      - /opt/mailcow-data/sogo:/var/lib/sogo:rw
    ports:
      - "143:143"
      - "993:993"
      - "110:110"
      - "995:995"
      - "4190:4190"
    networks:
      mailcow-network:
        aliases:
          - dovecot

  php-fpm-mailcow:
    image: ghcr.io/mailcow/phpfpm:1.94
    restart: always
    depends_on:
      - redis-mailcow
    environment:
      # ADDED DBHOST & REDISHOST
      - DBHOST=mysql
      - REDISHOST=redis
      - DBNAME=${DBNAME}
      - DBUSER=${DBUSER}
      - DBPASS=${DBPASS}
      - MAILCOW_HOSTNAME=${MAILCOW_HOSTNAME}
      - IMAP_PORT=143
      - SIEVE_PORT=4190
      - POP_PORT=110
      - TZ=${TZ}
    volumes:
      - /opt/mailcow-data/web:/web:rw
      - /opt/mailcow-data/conf/rspamd/dynmaps:/dynmaps:ro
      - /opt/mailcow-data/assets/templates:/tpls:ro
      - /opt/mailcow-data/assets/ssl:/etc/ssl/mail:ro
      - /opt/mailcow-data/web/inc/vars.local.inc.php:/web/inc/vars.local.inc.php:rw
      - /opt/mailcow-data/dkim:/data/dkim:rw
    networks:
      mailcow-network:
        aliases:
          - phpfpm

  sogo-mailcow:
    image: ghcr.io/mailcow/sogo:1.136
    restart: always
    environment:
      # ADDED DBHOST
      - DBHOST=mysql
      - DBNAME=${DBNAME}
      - DBUSER=${DBUSER}
      - DBPASS=${DBPASS}
      - TZ=${TZ}
    volumes:
      - /opt/mailcow-data/conf/sogo:/etc/sogo:rw
      - /opt/mailcow-data/web/inc/init_db.inc.php:/init_db.inc.php:ro
      - /opt/mailcow-data/sogo:/var/lib/sogo:rw
    networks:
      mailcow-network:
        aliases:
          - sogo

  rspamd-mailcow:
    image: ghcr.io/mailcow/rspamd:2.4
    restart: always
    environment:
      - TZ=${TZ}
      - REDISHOST=redis
    volumes:
      - /opt/mailcow-data/conf/rspamd/custom:/etc/rspamd/custom:rw
      - /opt/mailcow-data/conf/rspamd/override.d:/etc/rspamd/override.d:rw
      - /opt/mailcow-data/conf/rspamd/local.d:/etc/rspamd/local.d:rw
      - /opt/mailcow-data/assets/ssl:/etc/ssl/mail:ro
      - /opt/mailcow-data/dkim:/data/dkim:ro
    networks:
      mailcow-network:
        aliases:
          - rspamd

  acme-mailcow:
    image: ghcr.io/mailcow/acme:1.94
    depends_on:
      - nginx-mailcow
    environment:
      - LOG_LINES=9999
      - TZ=${TZ}
      - SKIP_LETS_ENCRYPT=${SKIP_LETS_ENCRYPT:-y}
    volumes:
      - /opt/mailcow-data/web/.well-known/acme-challenge:/var/www/acme:rw
      - /opt/mailcow-data/assets/ssl:/var/lib/acme:rw
    networks:
      mailcow-network:
        aliases:
          - acme

  netfilter-mailcow:
    image: ghcr.io/mailcow/netfilter:1.63
    restart: always
    volumes:
      - /opt/mailcow-data/conf/netfilter:/etc/netfilter2fail2ban:rw
      - /var/run/xtables.lock:/var/run/xtables.lock:ro
    privileged: true
    network_mode: "host"

  watchdog-mailcow:
    image: ghcr.io/mailcow/watchdog:2.09
    restart: always
    environment:
      - DBHOST=mysql
      - REDISHOST=redis
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /opt/mailcow-data/assets/ssl:/etc/ssl/mail:ro
    networks:
      mailcow-network:
        aliases:
          - watchdog
          
  ofelia-mailcow:
    image: mcuadros/ofelia:latest
    restart: always
    command: daemon --config /etc/ofelia/config.ini
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /opt/mailcow-data/conf/ofelia:/etc/ofelia:rw
    networks:
      mailcow-network:
        aliases:
          - ofelia

  olefy-mailcow:
    image: ghcr.io/mailcow/olefy:1.15
    restart: always
    networks:
      mailcow-network:
        aliases:
          - olefy

networks:
  mailcow-network:
    driver: bridge
    enable_ipv6: true
    ipam:
      driver: default
      config:
        - subnet: 10.123.123.0/24
  dokploy-network:
    external: true
    name: dokploy-network
